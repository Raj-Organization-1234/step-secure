name: cfnrelease_to_prod

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions: # added using https://github.com/step-security/secure-workflows
  contents: read
  id-token: write # for harden-runner policy

jobs:
  publish-prod:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@cb605e52c26070c328afc4562f0b4ada7618a84e # v2.10.4
        with:
          policy: agent-api-prod

      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        with:
          fetch-depth: 0

      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        with:
          repository: step-security/secure-repo
          path: secure-repo

      - name: Fetch latest commit SHA for IMAGE_TAG
        id: latest-commit
        run: |
          sha=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/step-security/secure-repo/commits | jq -r '.[0].sha')
          echo "IMAGE_TAG=${{ github.sha }}$sha" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.sha }}$sha" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@67fbcbb121271f7775d2e7715933280b06314838 # v1.7.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_BETA }} # 277233109775 beta env
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_BETA }}
          aws-region: us-west-2

      - name: Deploy to AWS CloudFormation
        uses: aws-actions/aws-cloudformation-github-deploy@33527b83bddcf6b3f0b135d9550bde8475325c73 # v1.3.0
        with:
          name: agent-api-ecr
          template: cfn/ecr.yml
          parameter-overrides: "ResourceName=agentapi"
          no-fail-on-empty-changeset: "1"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@2fc7aceee09e9e4a7105c0d060c656fad0b4f63d # v1.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5 # v3.8.0

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: agentapi
        uses: docker/build-push-action@67a2d409c0a876cbe6b11854e3e25193efe4e62d # v6.12.0
        with:
          push: true
          context: ./ # Ensure context is the local file system
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          provenance: false
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache
          cache-to: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:buildcache,mode=max,image-manifest=true,oci-mediatypes=true

      - name: Upload CloudFormation Template to S3
        uses: docker://amazon/aws-cli:2.0.7@sha256:30119932960947db22fcbabf465c4974134cc30c2c6dc2936694befd55b6ae99
        with:
          args: s3 cp cfn/resources.yml s3://agent-api-deploy-cfn/resources.yml

      - name: Deploy to AWS CloudFormation
        uses: aws-actions/aws-cloudformation-github-deploy@33527b83bddcf6b3f0b135d9550bde8475325c73 # v1.3.0
        with:
          name: agent-api
          template: https://agent-api-deploy-cfn.s3.amazonaws.com/resources.yml
          parameter-overrides: >-
            ResourceName=agentapi,
            ImageTag=${{ steps.latest-commit.outputs.IMAGE_TAG }},
            ClientId=Iv1.ad96d1f00234487b,
            ClientSecret=${{ secrets.CLIENTSECRET }},
            InstallationId=42215337|42215536|42215615|50820679|50820851|50820908|50820965|50821019|50821082|50821126|55633022|55633050|55633065|55633070|55633078,
            ReleaseMonitorApplicationId=200280,
            ReleaseMonitorPrivateKey=${{ secrets.RELEASEMONPRIVATEKEY }},
            PAT=${{ secrets.PAT }},
            StepSecurityAppClientId=Iv1.373795ecf4dad680,
            StepSecurityAppClientSecret=${{ secrets.STEPSECURITYAPPCLIENTSECRET }},
            Env=prod,
            HardenRunnerGitHubAppPrivateKey=${{ secrets.HARDENRUNNERGITHUBAPPPRIVATEKEY }},
            CloudfrontCustomDomain=raw-events.agent.api.stepsecurity.io,
            CertificateARN=arn:aws:acm:us-east-1:277233109775:certificate/bbc81aa0-88c9-4171-8202-f5f9a73b213c
          no-fail-on-empty-changeset: "1"
